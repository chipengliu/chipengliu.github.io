<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-aj.png?v=7.0.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-aj.png?v=7.0.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-aj.png?v=7.0.0">


  <link rel="mask-icon" href="/images/logo-aj.svg?v=7.0.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.0.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="ReactiveCocoa 框架 RACSignal+Operations.h 定义了 RACSignal 常规操作方法，接下来对一些常用的方法进行分析并解析其作用。">
<meta name="keywords" content="ReactiveCocoa,iOS">
<meta property="og:type" content="article">
<meta property="og:title" content="RACSignal常用方法深入分析(1)">
<meta property="og:url" content="https://chipengliu.github.io/2019/01/20/RACSignal-Operations/index.html">
<meta property="og:site_name" content="Laucp&#39;s Blog">
<meta property="og:description" content="ReactiveCocoa 框架 RACSignal+Operations.h 定义了 RACSignal 常规操作方法，接下来对一些常用的方法进行分析并解析其作用。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://chipengliu.github.io/2019/01/20/RACSignal-Operations/image-20190126201245265.png">
<meta property="og:updated_time" content="2020-10-24T01:58:24.822Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="RACSignal常用方法深入分析(1)">
<meta name="twitter:description" content="ReactiveCocoa 框架 RACSignal+Operations.h 定义了 RACSignal 常规操作方法，接下来对一些常用的方法进行分析并解析其作用。">
<meta name="twitter:image" content="https://chipengliu.github.io/2019/01/20/RACSignal-Operations/image-20190126201245265.png">



  <link rel="alternate" href="/atom.xml" title="Laucp's Blog" type="application/atom+xml">




  <link rel="canonical" href="https://chipengliu.github.io/2019/01/20/RACSignal-Operations/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>RACSignal常用方法深入分析(1) | Laucp's Blog</title>
  






  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?d6b51085664ec346aabac2fbff8b0b07";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>







  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Laucp's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://chipengliu.github.io/2019/01/20/RACSignal-Operations/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Chipengliu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Laucp's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">RACSignal常用方法深入分析(1)

              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-01-20 14:54:02" itemprop="dateCreated datePublished" datetime="2019-01-20T14:54:02+08:00">2019-01-20</time>
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon">
            <i class="fa fa-eye"></i>
             阅读次数： 
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>ReactiveCocoa 框架 RACSignal+Operations.h 定义了 RACSignal 常规操作方法，接下来对一些常用的方法进行分析并解析其作用。</p>
<a id="more"></a>
<h3 id="doNext"><a href="#doNext" class="headerlink" title="doNext"></a>doNext</h3><p>测试代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)testDoNext &#123;</span><br><span class="line">    RACSignal *sourceSignal = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">        [subscriber sendNext:<span class="string">@"source signal"</span>];</span><br><span class="line">        </span><br><span class="line">        [subscriber sendCompleted];</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    [[sourceSignal doNext:^(<span class="keyword">id</span>  _Nullable x) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"sourceSignal doNext will execute before sendNext"</span>);</span><br><span class="line">    &#125;] subscribeNext:^(<span class="keyword">id</span>  _Nullable x) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"value = %@"</span>, x);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sourceSignal doNext will execute before sendNext</span><br><span class="line">value = source signal</span><br></pre></td></tr></table></figure>
<p>底层实现:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (RACSignal *)doNext:(<span class="keyword">void</span> (^)(<span class="keyword">id</span> x))block &#123;</span><br><span class="line">	<span class="built_in">NSCParameterAssert</span>(block != <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> [[RACSignal createSignal:^(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">		<span class="keyword">return</span> [<span class="keyword">self</span> subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">			block(x);</span><br><span class="line">			[subscriber sendNext:x];</span><br><span class="line">		&#125; error:^(<span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">			[subscriber sendError:error];</span><br><span class="line">		&#125; completed:^&#123;</span><br><span class="line">			[subscriber sendCompleted];</span><br><span class="line">		&#125;];</span><br><span class="line">	&#125;] setNameWithFormat:<span class="string">@"[%@] -doNext:"</span>, <span class="keyword">self</span>.name];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>doNext 传入block 闭包，该闭包的参数就是原信号发送的值，当给订阅者发送 sendNext 之前会执行 block 闭包</p>
<p>类似的 doError，doCompleted 也是在给订阅者发送事件之前就执行相关 block</p>
<h3 id="throttle-valuesPassingTest"><a href="#throttle-valuesPassingTest" class="headerlink" title="throttle:valuesPassingTest:"></a>throttle:valuesPassingTest:</h3><p>测试代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)testThrottleValuesPassingTest &#123;</span><br><span class="line">    RACSignal *sourceSignal = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">        [subscriber sendNext:@<span class="number">0</span>];</span><br><span class="line">        [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="number">2</span> * <span class="built_in">NSEC_PER_SEC</span>)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">            </span><br><span class="line">            [subscriber sendNext:@<span class="number">2</span>];</span><br><span class="line">            [subscriber sendNext:@<span class="number">3</span>];</span><br><span class="line">            [subscriber sendCompleted];</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    RACSignal *throttleSignal = [sourceSignal throttle:<span class="number">1</span> valuesPassingTest:^<span class="built_in">BOOL</span>(<span class="keyword">id</span>  _Nullable next) &#123;</span><br><span class="line">        <span class="keyword">return</span> [next integerValue] &lt;= <span class="number">2</span>;</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    [throttleSignal subscribeNext:^(<span class="keyword">id</span>  _Nullable x) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"value = %@"</span>, x);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">value = 1</span><br><span class="line">value = 3</span><br></pre></td></tr></table></figure>
<p>throttle:valuesPassingTest: 方法有2个参数：</p>
<ul>
<li>时间间隔 <code>interval</code></li>
<li>判断条件闭包 <code>predicate</code></li>
</ul>
<p>该方法大概作用是：从原信号发出第一个信号(@0)发出开始计时，在 <code>interval</code> 秒内如果第二个信号(@1) 符合 predicate 的判断条件，则该前一个信号会被忽略；如果2个信号间隔时间超过  <code>interval</code> 秒或者不满足 predicate 判断，则前一个信号会发给订阅者。</p>
<p>底层实现：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">- (RACSignal *)throttle:(<span class="built_in">NSTimeInterval</span>)interval valuesPassingTest:(<span class="built_in">BOOL</span> (^)(<span class="keyword">id</span> next))predicate &#123;</span><br><span class="line">	<span class="built_in">NSCParameterAssert</span>(interval &gt;= <span class="number">0</span>);</span><br><span class="line">	<span class="built_in">NSCParameterAssert</span>(predicate != <span class="literal">nil</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> [[RACSignal createSignal:^(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">		RACCompoundDisposable *compoundDisposable = [RACCompoundDisposable compoundDisposable];</span><br><span class="line"></span><br><span class="line">		<span class="comment">// We may never use this scheduler, but we need to set it up ahead of</span></span><br><span class="line">		<span class="comment">// time so that our scheduled blocks are run serially if we do.</span></span><br><span class="line">		RACScheduler *scheduler = [RACScheduler scheduler];</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Information about any currently-buffered `next` event.</span></span><br><span class="line">		__block <span class="keyword">id</span> nextValue = <span class="literal">nil</span>;</span><br><span class="line">		__block <span class="built_in">BOOL</span> hasNextValue = <span class="literal">NO</span>;</span><br><span class="line">		RACSerialDisposable *nextDisposable = [[RACSerialDisposable alloc] init];</span><br><span class="line"></span><br><span class="line">		<span class="keyword">void</span> (^flushNext)(<span class="built_in">BOOL</span> send) = ^(<span class="built_in">BOOL</span> send) &#123;</span><br><span class="line">			<span class="keyword">@synchronized</span> (compoundDisposable) &#123;</span><br><span class="line">				[nextDisposable.disposable dispose];</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (!hasNextValue) <span class="keyword">return</span>;</span><br><span class="line">				<span class="keyword">if</span> (send) [subscriber sendNext:nextValue];</span><br><span class="line"></span><br><span class="line">				nextValue = <span class="literal">nil</span>;</span><br><span class="line">				hasNextValue = <span class="literal">NO</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		RACDisposable *subscriptionDisposable = [<span class="keyword">self</span> subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">			RACScheduler *delayScheduler = RACScheduler.currentScheduler ?: scheduler;</span><br><span class="line">			<span class="built_in">BOOL</span> shouldThrottle = predicate(x);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">@synchronized</span> (compoundDisposable) &#123;</span><br><span class="line">				flushNext(<span class="literal">NO</span>);</span><br><span class="line">				<span class="keyword">if</span> (!shouldThrottle) &#123;</span><br><span class="line">					[subscriber sendNext:x];</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				nextValue = x;</span><br><span class="line">				hasNextValue = <span class="literal">YES</span>;</span><br><span class="line">				nextDisposable.disposable = [delayScheduler afterDelay:interval schedule:^&#123;</span><br><span class="line">					flushNext(<span class="literal">YES</span>);</span><br><span class="line">				&#125;];</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; error:^(<span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">			[compoundDisposable dispose];</span><br><span class="line">			[subscriber sendError:error];</span><br><span class="line">		&#125; completed:^&#123;</span><br><span class="line">			flushNext(<span class="literal">YES</span>);</span><br><span class="line">			[subscriber sendCompleted];</span><br><span class="line">		&#125;];</span><br><span class="line"></span><br><span class="line">		[compoundDisposable addDisposable:subscriptionDisposable];</span><br><span class="line">		<span class="keyword">return</span> compoundDisposable;</span><br><span class="line">	&#125;] setNameWithFormat:<span class="string">@"[%@] -throttle: %f valuesPassingTest:"</span>, <span class="keyword">self</span>.name, (<span class="keyword">double</span>)interval];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>throttle:valuesPassingTest: 内部主要通过判断 <code>nextValue</code> 和 <code>hasNextValue</code> 2个变量的状态来判断是否给订阅者发送信号。内部先订阅原信号，然后触发订阅者的 didSubscribe，结合测试代码，具体流程:</p>
<ol>
<li>收到原信号发出的信号 <code>@0</code>，传入到条件闭包 predicate，返回 YES</li>
<li>RACCompoundDisposable 作为线程间互斥信号量，用 @synchronized 加锁保证  <code>nextValue</code>  和  <code>hasNextValue</code> 操作是原子性</li>
<li>执行 flushNext(NO) ，把 nextDisposable 进行 dispose，delayScheduler 之前存放的延迟任务如果未被执行会被取消；hasNextValue == NO，直接 return，没有给订阅者发送0</li>
<li>判断 !shouldThrottle，跳过 if 内部代码，给 nextValue 和 hasNextValue 赋值，nextValue=@0，hasNextValue = YES</li>
<li>把 flushNext(YES) 加入到延迟队列中，1秒后执行</li>
<li>原信号发送 @1，此时时间间隔不到 1秒，从步骤3开始重复上述步骤；flushNext(NO) 中 延迟任务被取消， <code>nextValue</code> 和 <code>hasNextValue</code> 会赋值为对应 零值。shouldThrottle 符合，<code>nextValue</code> 和 <code>hasNextValue</code>  又被赋值到 @1 和 YES，保存新的 flushNext(YES) 到延迟任务队列中</li>
<li>1秒后还没有收到原信号发送的信号，执行步骤6保存的 flushNext(YES)，把 @1 发给订阅者；2秒后收到原信号的信号 @2，从步骤3开始重复上述步骤，@2会被保存到  <code>hasNextValue</code>  中，等待下一次延迟任务可以触发的时候发给订阅者，反之被忽略</li>
<li>步骤7完之后马上收到新的信号@3，从步骤3开始重复上述步骤，步骤7保存的 flushNext(YES) 被取消，因为此时不符合 predicate 判断条件，@3发给订阅者</li>
</ol>
<h3 id="delay"><a href="#delay" class="headerlink" title="delay:"></a>delay:</h3><p>测试代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)testDelay &#123;</span><br><span class="line">    RACSignal *sourceSignal = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">        [subscriber sendNext:@<span class="number">0</span>];</span><br><span class="line">        [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">        [subscriber sendNext:@<span class="number">2</span>];</span><br><span class="line">        [subscriber sendNext:@<span class="number">3</span>];</span><br><span class="line">        [subscriber sendCompleted];</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    [[sourceSignal delay:<span class="number">1</span>] subscribeNext:^(<span class="keyword">id</span>  _Nullable x) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"value = %@"</span>, x);</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [<span class="built_in">NSDate</span> date]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2019</span><span class="number">-01</span><span class="number">-31</span> <span class="number">09</span>:<span class="number">34</span>:<span class="number">33.286371</span>+<span class="number">0800</span> AppTest[<span class="number">38331</span>:<span class="number">4774309</span>] Thu Jan <span class="number">31</span> <span class="number">09</span>:<span class="number">34</span>:<span class="number">33</span> <span class="number">2019</span></span><br><span class="line"><span class="number">2019</span><span class="number">-01</span><span class="number">-31</span> <span class="number">09</span>:<span class="number">34</span>:<span class="number">34.380736</span>+<span class="number">0800</span> AppTest[<span class="number">38331</span>:<span class="number">4774309</span>] value = <span class="number">0</span></span><br><span class="line"><span class="number">2019</span><span class="number">-01</span><span class="number">-31</span> <span class="number">09</span>:<span class="number">34</span>:<span class="number">34.380881</span>+<span class="number">0800</span> AppTest[<span class="number">38331</span>:<span class="number">4774309</span>] value = <span class="number">1</span></span><br><span class="line"><span class="number">2019</span><span class="number">-01</span><span class="number">-31</span> <span class="number">09</span>:<span class="number">34</span>:<span class="number">34.380986</span>+<span class="number">0800</span> AppTest[<span class="number">38331</span>:<span class="number">4774309</span>] value = <span class="number">2</span></span><br><span class="line"><span class="number">2019</span><span class="number">-01</span><span class="number">-31</span> <span class="number">09</span>:<span class="number">34</span>:<span class="number">34.381076</span>+<span class="number">0800</span> AppTest[<span class="number">38331</span>:<span class="number">4774309</span>] value = <span class="number">3</span></span><br></pre></td></tr></table></figure>
<p>delay: 方法是将原信号的信号事件延迟发送给订阅者</p>
<p>底层实现：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">- (RACSignal *)delay:(<span class="built_in">NSTimeInterval</span>)interval &#123;</span><br><span class="line">	<span class="keyword">return</span> [[RACSignal createSignal:^(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">		RACCompoundDisposable *disposable = [RACCompoundDisposable compoundDisposable];</span><br><span class="line"></span><br><span class="line">		<span class="comment">// We may never use this scheduler, but we need to set it up ahead of</span></span><br><span class="line">		<span class="comment">// time so that our scheduled blocks are run serially if we do.</span></span><br><span class="line">		RACScheduler *scheduler = [RACScheduler scheduler];</span><br><span class="line"></span><br><span class="line">		<span class="keyword">void</span> (^schedule)(dispatch_block_t) = ^(dispatch_block_t block) &#123;</span><br><span class="line">			RACScheduler *delayScheduler = RACScheduler.currentScheduler ?: scheduler;</span><br><span class="line">			RACDisposable *schedulerDisposable = [delayScheduler afterDelay:interval schedule:block];</span><br><span class="line">			[disposable addDisposable:schedulerDisposable];</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		RACDisposable *subscriptionDisposable = [<span class="keyword">self</span> subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">			schedule(^&#123;</span><br><span class="line">				[subscriber sendNext:x];</span><br><span class="line">			&#125;);</span><br><span class="line">		&#125; error:^(<span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">			[subscriber sendError:error];</span><br><span class="line">		&#125; completed:^&#123;</span><br><span class="line">			schedule(^&#123;</span><br><span class="line">				[subscriber sendCompleted];</span><br><span class="line">			&#125;);</span><br><span class="line">		&#125;];</span><br><span class="line"></span><br><span class="line">		[disposable addDisposable:subscriptionDisposable];</span><br><span class="line">		<span class="keyword">return</span> disposable;</span><br><span class="line">	&#125;] setNameWithFormat:<span class="string">@"[%@] -delay: %f"</span>, <span class="keyword">self</span>.name, (<span class="keyword">double</span>)interval];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>delay: 内部首先先定义 schedule ，其参数是 dispatch_block_t，执行 schedule 的时候，会把参数 block 放到 RACScheduler 延迟 interval 秒触发。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">- (RACDisposable *)afterDelay:(<span class="built_in">NSTimeInterval</span>)delay schedule:(<span class="keyword">void</span> (^)(<span class="keyword">void</span>))block &#123;</span><br><span class="line">	<span class="keyword">return</span> [<span class="keyword">self</span> after:[<span class="built_in">NSDate</span> dateWithTimeIntervalSinceNow:delay] schedule:block];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (RACDisposable *)after:(<span class="built_in">NSDate</span> *)date schedule:(<span class="keyword">void</span> (^)(<span class="keyword">void</span>))block &#123;</span><br><span class="line">	<span class="built_in">NSCParameterAssert</span>(date != <span class="literal">nil</span>);</span><br><span class="line">	<span class="built_in">NSCParameterAssert</span>(block != <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	RACDisposable *disposable = [[RACDisposable alloc] init];</span><br><span class="line"></span><br><span class="line">	dispatch_after([<span class="keyword">self</span>.class wallTimeWithDate:date], <span class="keyword">self</span>.queue, ^&#123;</span><br><span class="line">		<span class="keyword">if</span> (disposable.disposed) <span class="keyword">return</span>;</span><br><span class="line">		[<span class="keyword">self</span> performAsCurrentScheduler:block];</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> disposable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据测试代码，最终会调用 RACQueueScheduler 中的 <code>-after:schedule:</code>，在该方法里面，通过 dispatch_after 来触发入参 block，触发先前会先判断该任务是否被 disposed ，如果是则直接 return。</p>
<p>归纳来说，delay: 方法就是将原信号的 sendNext 和 sendCompleted 事件延迟 <code>interval</code> 秒发送给订阅者。</p>
<h3 id="bufferWithTime-onScheduler"><a href="#bufferWithTime-onScheduler" class="headerlink" title="bufferWithTime:onScheduler:"></a>bufferWithTime:onScheduler:</h3><p>测试代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)testBufferWithTime &#123;</span><br><span class="line">    RACSignal *sourceSignal = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">        [subscriber sendNext:@<span class="number">0</span>];</span><br><span class="line">        [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">        [subscriber sendNext:@<span class="number">2</span>];</span><br><span class="line">        [subscriber sendNext:@<span class="number">3</span>];</span><br><span class="line">        [subscriber sendCompleted];</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    RACSignal *bufferSignal = [sourceSignal bufferWithTime:<span class="number">1</span> onScheduler:[RACScheduler currentScheduler]];</span><br><span class="line">    [bufferSignal subscribeNext:^(<span class="keyword">id</span>  _Nullable x) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"value = %@"</span>, x);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">value = &lt;RACTuple: 0x600000003200&gt; (</span><br><span class="line">    0,</span><br><span class="line">    1,</span><br><span class="line">    2,</span><br><span class="line">    3</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>底层实现：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">- (RACSignal *)bufferWithTime:(<span class="built_in">NSTimeInterval</span>)interval onScheduler:(RACScheduler *)scheduler &#123;</span><br><span class="line">	<span class="built_in">NSCParameterAssert</span>(scheduler != <span class="literal">nil</span>);</span><br><span class="line">	<span class="built_in">NSCParameterAssert</span>(scheduler != RACScheduler.immediateScheduler);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> [[RACSignal createSignal:^(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">		RACSerialDisposable *timerDisposable = [[RACSerialDisposable alloc] init];</span><br><span class="line">		<span class="built_in">NSMutableArray</span> *values = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line"></span><br><span class="line">		<span class="keyword">void</span> (^flushValues)() = ^&#123;</span><br><span class="line">			<span class="keyword">@synchronized</span> (values) &#123;</span><br><span class="line">				[timerDisposable.disposable dispose];</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (values.count == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">				RACTuple *tuple = [RACTuple tupleWithObjectsFromArray:values];</span><br><span class="line">				[values removeAllObjects];</span><br><span class="line">				[subscriber sendNext:tuple];</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		RACDisposable *selfDisposable = [<span class="keyword">self</span> subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">			<span class="keyword">@synchronized</span> (values) &#123;</span><br><span class="line">				<span class="keyword">if</span> (values.count == <span class="number">0</span>) &#123;</span><br><span class="line">					timerDisposable.disposable = [scheduler afterDelay:interval schedule:flushValues];</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				[values addObject:x ?: RACTupleNil.tupleNil];</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; error:^(<span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">			[subscriber sendError:error];</span><br><span class="line">		&#125; completed:^&#123;</span><br><span class="line">			flushValues();</span><br><span class="line">			[subscriber sendCompleted];</span><br><span class="line">		&#125;];</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> [RACDisposable disposableWithBlock:^&#123;</span><br><span class="line">			[selfDisposable dispose];</span><br><span class="line">			[timerDisposable dispose];</span><br><span class="line">		&#125;];</span><br><span class="line">	&#125;] setNameWithFormat:<span class="string">@"[%@] -bufferWithTime: %f onScheduler: %@"</span>, <span class="keyword">self</span>.name, (<span class="keyword">double</span>)interval, scheduler];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同样 bufferWithTime:onScheduler: 内部还会创建新的信号，当新的信号被订阅的时候会创建可变数组 values 。然后定义闭包 flushValues，当收到原信号的 sendNext 和 sendCompleted 的时候会触发该闭包。</p>
<p>之后对原信号进行订阅，首先收到原信号的 sendNext 事件的时候，先判断 values 的元素个数，如果个数为 0，则把 flushValues 延迟 <code>interval</code> 秒触发。然后把信号值加入 values 数组中，如果信号值为空，则把 RACTupleNil.tupleNil 加入数组中。</p>
<p>因为测试代码中，@0、@1、@2、@3 四个信号是连续串行发出，所以之前被加入延迟队列中执行的 flushValues 还没有触发的时候，当原信号发送 sendCompleted 的时候，flushValues 会被触发，这时候 values 四个元素被一次性包装成 RACTuple 发送给订阅者。</p>
<p>如果把测试代码修改成：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)testBufferWithTime2 &#123;</span><br><span class="line">    RACSignal *sourceSignal = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">        [subscriber sendNext:@<span class="number">0</span>];</span><br><span class="line">        [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="number">2</span> * <span class="built_in">NSEC_PER_SEC</span>)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">            [subscriber sendNext:@<span class="number">2</span>];</span><br><span class="line">            [subscriber sendNext:@<span class="number">3</span>];</span><br><span class="line">            dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="number">2</span> * <span class="built_in">NSEC_PER_SEC</span>)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                [subscriber sendCompleted];</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    RACSignal *bufferSignal = [sourceSignal bufferWithTime:<span class="number">1</span> onScheduler:[RACScheduler currentScheduler]];</span><br><span class="line">    [bufferSignal subscribeNext:^(<span class="keyword">id</span>  _Nullable x) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"value = %@"</span>, x);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">value = &lt;RACTuple: <span class="number">0x604000204300</span>&gt; (</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    <span class="number">1</span></span><br><span class="line">)</span><br><span class="line">value = &lt;RACTuple: <span class="number">0x600000019300</span>&gt; (</span><br><span class="line">    <span class="number">2</span>,</span><br><span class="line">    <span class="number">3</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>订阅者此时会受到2个信号，都是 RACTuple 类型，回到之前的实现代码，</p>
<ol>
<li>收到 @0，flushValues() 加入延迟队列1秒之后执行，@0 再加入到数组 values 中</li>
<li>步骤1之后马上收到 @1（1秒内），重复步骤1，这时候延迟队列中有2个任务</li>
<li>1秒后，第一个加入延迟队列的 flushValues() 执行，首先执行了 <code>[timerDisposable.disposable dispose];</code> ，这样会将延迟队列中下一个  flushValues() 任务被取消（步骤2加入的）。然后 values 元素包装成 RACTuple 发送给订阅者。</li>
<li>基于步骤3，再过一秒，也就是从一开始算，2秒过后。收到@2，然后重复步骤，逻辑相似</li>
<li>最后再过2秒，原信号发送 sendCompleted，执行 flushValues() ，values 元素个数为0，直接返回。</li>
</ol>
<p>总结：bufferWithTime:onScheduler: 作用是将规定时间内将原信号所发送的全部信号包装成 RACTupe 发送给订阅者</p>
<h3 id="timeout-onScheduler"><a href="#timeout-onScheduler" class="headerlink" title="timeout:onScheduler:"></a>timeout:onScheduler:</h3><p>测试代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)testTimeout &#123;</span><br><span class="line">    RACSignal *sourceSignal = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">        [subscriber sendNext:@<span class="number">0</span>];</span><br><span class="line">        [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">        [subscriber sendNext:@<span class="number">2</span>];</span><br><span class="line">        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="number">1</span> * <span class="built_in">NSEC_PER_SEC</span>)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">            [subscriber sendNext:@<span class="number">3</span>];</span><br><span class="line">            [subscriber sendCompleted];</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    RACSignal *timeoutSig = [sourceSignal timeout:<span class="number">1</span> onScheduler:[RACScheduler currentScheduler]];</span><br><span class="line">    [timeoutSig subscribeNext:^(<span class="keyword">id</span>  _Nullable x) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"value = %@"</span>, x);</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    [timeoutSig subscribeError:^(<span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"error = %@"</span>, error);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">value = 0</span><br><span class="line">value = 1</span><br><span class="line">value = 2</span><br><span class="line">error = Error Domain=RACSignalErrorDomain Code=1 "(null)"</span><br></pre></td></tr></table></figure>
<p>底层实现：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">- (RACSignal *)timeout:(<span class="built_in">NSTimeInterval</span>)interval onScheduler:(RACScheduler *)scheduler &#123;</span><br><span class="line">	<span class="built_in">NSCParameterAssert</span>(scheduler != <span class="literal">nil</span>);</span><br><span class="line">	<span class="built_in">NSCParameterAssert</span>(scheduler != RACScheduler.immediateScheduler);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> [[RACSignal createSignal:^(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">		RACCompoundDisposable *disposable = [RACCompoundDisposable compoundDisposable];</span><br><span class="line"></span><br><span class="line">		RACDisposable *timeoutDisposable = [scheduler afterDelay:interval schedule:^&#123;</span><br><span class="line">			[disposable dispose];</span><br><span class="line">			[subscriber sendError:[<span class="built_in">NSError</span> errorWithDomain:RACSignalErrorDomain code:RACSignalErrorTimedOut userInfo:<span class="literal">nil</span>]];</span><br><span class="line">		&#125;];</span><br><span class="line"></span><br><span class="line">		[disposable addDisposable:timeoutDisposable];</span><br><span class="line"></span><br><span class="line">		RACDisposable *subscriptionDisposable = [<span class="keyword">self</span> subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">			[subscriber sendNext:x];</span><br><span class="line">		&#125; error:^(<span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">			[disposable dispose];</span><br><span class="line">			[subscriber sendError:error];</span><br><span class="line">		&#125; completed:^&#123;</span><br><span class="line">			[disposable dispose];</span><br><span class="line">			[subscriber sendCompleted];</span><br><span class="line">		&#125;];</span><br><span class="line"></span><br><span class="line">		[disposable addDisposable:subscriptionDisposable];</span><br><span class="line">		<span class="keyword">return</span> disposable;</span><br><span class="line">	&#125;] setNameWithFormat:<span class="string">@"[%@] -timeout: %f onScheduler: %@"</span>, <span class="keyword">self</span>.name, (<span class="keyword">double</span>)interval, scheduler];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>timeout:onScheduler: 判断从被订阅开始计时， <code>interval</code> 时间内如果原信号没有把所有信号发送完毕会给订阅者发送 error。</p>
<p>首先创建新的信号，新信号被订阅的时候在延迟队列里面加入任务， <code>interval</code>  后该任务会将 NSError 发送给订阅者。如果在  <code>interval</code>  内原型号发送了 sendCompleted/sendError，会执行 <code>[disposable dispose];</code>，延迟队列中的任务会被取消。同样如果延迟任务被触发，原信号的订阅也被终止。</p>
<h3 id="map"><a href="#map" class="headerlink" title="map:"></a>map:</h3><p>测试代码:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 代码1 */</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)testMap &#123;</span><br><span class="line">    RACSignal *sourceSignal = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">        [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">        [subscriber sendNext:@<span class="number">2</span>];</span><br><span class="line">        [subscriber sendNext:@<span class="number">3</span>];</span><br><span class="line">        </span><br><span class="line">        [subscriber sendCompleted];</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    [[sourceSignal map:^<span class="keyword">id</span> _Nullable(<span class="keyword">id</span>  _Nullable value) &#123;</span><br><span class="line">        <span class="comment">// BLOCK 1</span></span><br><span class="line">        <span class="keyword">return</span> @([value integerValue] + <span class="number">1</span>);</span><br><span class="line">    &#125;] subscribeNext:^(<span class="keyword">id</span>  _Nullable x) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"value = %@"</span>, x);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">value = 2</span><br><span class="line">value = 3</span><br><span class="line">value = 4</span><br></pre></td></tr></table></figure>
<p>底层实现:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 代码2 */</span></span><br><span class="line"></span><br><span class="line">- (__kindof RACStream *)map:(<span class="keyword">id</span> (^)(<span class="keyword">id</span> value))block &#123;</span><br><span class="line">	<span class="built_in">NSCParameterAssert</span>(block != <span class="literal">nil</span>);</span><br><span class="line"></span><br><span class="line">	Class <span class="keyword">class</span> = <span class="keyword">self</span>.class;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> [[<span class="keyword">self</span> flattenMap:^(<span class="keyword">id</span> value) &#123;</span><br><span class="line">        <span class="comment">// BLOCK 2</span></span><br><span class="line">		<span class="keyword">return</span> [<span class="keyword">class</span> <span class="keyword">return</span>:block(value)];</span><br><span class="line">	&#125;] setNameWithFormat:<span class="string">@"[%@] -map:"</span>, <span class="keyword">self</span>.name];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>map 的参数一个参数类型为id，返回值类型也为id的block，内部实现首先通过断言判断 block 是否为空，然后调用 flattenMap 方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 代码3 */</span></span><br><span class="line"></span><br><span class="line">- (__kindof RACStream *)flattenMap:(__kindof RACStream * (^)(<span class="keyword">id</span> value))block &#123;</span><br><span class="line">	Class <span class="keyword">class</span> = <span class="keyword">self</span>.class;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> [[<span class="keyword">self</span> bind:^&#123;</span><br><span class="line">		<span class="keyword">return</span> ^(<span class="keyword">id</span> value, <span class="built_in">BOOL</span> *stop) &#123;</span><br><span class="line">            <span class="comment">// BLOCK 3</span></span><br><span class="line">            </span><br><span class="line">			<span class="keyword">id</span> stream = block(value) ?: [<span class="keyword">class</span> empty];</span><br><span class="line">			<span class="built_in">NSCAssert</span>([stream isKindOfClass:RACStream.class], <span class="string">@"Value returned from -flattenMap: is not a stream: %@"</span>, stream);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> stream;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;] setNameWithFormat:<span class="string">@"[%@] -flattenMap:"</span>, <span class="keyword">self</span>.name];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>flattenMap 是通过封装 bind 方法实现，bind的入参是 RACStreamBindBlock 类型闭包，flattenMap 的入参是一个入参类型为 id，返回值为 RACStream 的闭包</p>
<p>在 flattenMap 中，先判断 block(value) 返回的信号是否为nil，若是则返对应class 的empty 信号，也就是 RACEmptySignal 对象</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">+ (RACSignal *)empty &#123;</span><br><span class="line"><span class="meta">#ifdef DEBUG</span></span><br><span class="line">	<span class="comment">// Create multiple instances of this class in DEBUG so users can set custom</span></span><br><span class="line">	<span class="comment">// names on each.</span></span><br><span class="line">	<span class="keyword">return</span> [[[<span class="keyword">self</span> alloc] init] setNameWithFormat:<span class="string">@"+empty"</span>];</span><br><span class="line"><span class="meta">#else</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">id</span> singleton;</span><br><span class="line">	<span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> pred;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">dispatch_once</span>(&amp;pred, ^&#123;</span><br><span class="line">		singleton = [[<span class="keyword">self</span> alloc] init];</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> singleton;</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从实现代码上来看，RACEmptySignal 是以单例对象的形式返回</p>
<p>RACEmptySignal.m 文件里还重写了 <code>-subscribe</code>:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (RACDisposable *)subscribe:(<span class="keyword">id</span>&lt;RACSubscriber&gt;)subscriber &#123;</span><br><span class="line">	<span class="built_in">NSCParameterAssert</span>(subscriber != <span class="literal">nil</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> [RACScheduler.subscriptionScheduler schedule:^&#123;</span><br><span class="line">		[subscriber sendCompleted];</span><br><span class="line">	&#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>RACEmptySignal 信号被订阅之后会马上给订阅者发送 sendCompleted 事件</p>
<p>回到 flattenMap 的实现逻辑中，如果 block(value)  返回不是nil，它是如何返回 RACStream 对象的呢？</p>
<p>执行 block(value) 实际上就是触发 代码2 中的 <code>BLOCK 2</code></p>
<p>在 <code>BLOCK 2</code>  中，又会触发另个 block(value)，这时候会触发代码1中的 <code>BLOCK 1</code>，这里 block(value) 会返回相关对象（测试代码中返回NSNumber），<code>BLOCK 2</code> 中将 NSNumber 包装成 RACReturnSignal 返回，此时在 <code>BLOCK 3</code>  stream 对象就是 RACReturnSignal。</p>
<p>最后通过 bind 函数的变换，订阅会收到变换过后的值。</p>
<p><img src="/2019/01/20/RACSignal-Operations/image-20190126201245265.png" alt="image-20190126201245265"></p>
<h3 id="mapReplace"><a href="#mapReplace" class="headerlink" title="mapReplace"></a>mapReplace</h3><p>测试代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)testMapReplace &#123;</span><br><span class="line">    RACSignal *sourceSignal = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">        [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">        [subscriber sendNext:@<span class="number">2</span>];</span><br><span class="line">        [subscriber sendNext:@<span class="number">3</span>];</span><br><span class="line">        </span><br><span class="line">        [subscriber sendCompleted];</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    [[sourceSignal mapReplace:@(<span class="number">10</span>)] subscribeNext:^(<span class="keyword">id</span>  _Nullable x) &#123;</span><br><span class="line">         <span class="built_in">NSLog</span>(<span class="string">@"value = %@"</span>, x);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">value = 10</span><br><span class="line">value = 10</span><br><span class="line">value = 10</span><br></pre></td></tr></table></figure>
<p>底层实现：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (__kindof RACStream *)mapReplace:(<span class="keyword">id</span>)object &#123;</span><br><span class="line">	<span class="keyword">return</span> [[<span class="keyword">self</span> map:^(<span class="keyword">id</span> _) &#123;</span><br><span class="line">		<span class="keyword">return</span> object;</span><br><span class="line">	&#125;] setNameWithFormat:<span class="string">@"[%@] -mapReplace: %@"</span>, <span class="keyword">self</span>.name, RACDescription(object)];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mapReplace 是通过封装 map 方法实现，把原信号每一个事件都变换成参数 object 传递给订阅者</p>
<h3 id="reduceEach"><a href="#reduceEach" class="headerlink" title="reduceEach"></a>reduceEach</h3><p>测试代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)testReduceEach &#123;</span><br><span class="line">    RACSignal *signal1 = [RACSignal createSignal:</span><br><span class="line">                          ^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber)</span><br><span class="line">                          &#123;</span><br><span class="line">                              [subscriber sendNext:RACTuplePack(@<span class="number">1</span>,@<span class="number">2</span>)];</span><br><span class="line">                              [subscriber sendNext:RACTuplePack(@<span class="number">3</span>,@<span class="number">4</span>)];</span><br><span class="line">                              [subscriber sendNext:RACTuplePack(@<span class="number">5</span>,@<span class="number">6</span>)];</span><br><span class="line">                              [subscriber sendCompleted];</span><br><span class="line">                              <span class="keyword">return</span> [RACDisposable disposableWithBlock:^&#123;</span><br><span class="line">                                  <span class="built_in">NSLog</span>(<span class="string">@"signal1 dispose"</span>);</span><br><span class="line">                              &#125;];</span><br><span class="line">                          &#125;];</span><br><span class="line">    </span><br><span class="line">    RACSignal *signal2 = [signal1 reduceEach:^<span class="keyword">id</span> (<span class="built_in">NSNumber</span> *num1 , <span class="built_in">NSNumber</span> *num2)&#123;</span><br><span class="line">        <span class="keyword">return</span> @([num1 intValue] + [num2 intValue]);</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    [signal2 subscribeNext:^(<span class="keyword">id</span>  _Nullable x) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"value = %@"</span>, x);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">value = 3</span><br><span class="line">value = 7</span><br><span class="line">value = 11</span><br><span class="line">signal1 dispose</span><br></pre></td></tr></table></figure>
<p>从输出结果看出来，reduceEach 将原信号 signal1 发送的 RACTuple 数据进行解包聚合发送给订阅者</p>
<p>底层实现：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 代码4 */</span></span><br><span class="line"></span><br><span class="line">- (__kindof RACStream *)reduceEach:(RACReduceBlock)reduceBlock &#123;</span><br><span class="line">	<span class="built_in">NSCParameterAssert</span>(reduceBlock != <span class="literal">nil</span>);</span><br><span class="line"></span><br><span class="line">	__<span class="keyword">weak</span> RACStream *stream __attribute__((unused)) = <span class="keyword">self</span>;</span><br><span class="line">	<span class="keyword">return</span> [[<span class="keyword">self</span> map:^(RACTuple *t) &#123;</span><br><span class="line">        <span class="comment">// BLOCK 1</span></span><br><span class="line">		<span class="built_in">NSCAssert</span>([t isKindOfClass:RACTuple.class], <span class="string">@"Value from stream %@ is not a tuple: %@"</span>, stream, t);</span><br><span class="line">		<span class="keyword">return</span> [RACBlockTrampoline invokeBlock:reduceBlock withArguments:t];</span><br><span class="line">	&#125;] setNameWithFormat:<span class="string">@"[%@] -reduceEach:"</span>, <span class="keyword">self</span>.name];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>reduceEach 也是通过封装 map 方法实现。reduceEach 方法的入参是 RACReduceBlock 类型的闭包</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">id</span> _Nonnull (^RACReduceBlock)();</span><br></pre></td></tr></table></figure>
<p>首先通过断言判断 reduceBlock 闭包是否为nil，然后调用 map 方法，map 方法的入参也就是 <code>BLOCK 1</code>，在  <code>BLOCK 1</code> 里会先判断原信号 signal 发送的数据 t 是否为 RACTuple 类型，然后返回 RACBlockTrampoline 类型对象</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">RACBlockTrampoline</span> ()</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>, <span class="keyword">copy</span>) <span class="keyword">id</span> block;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>RACBlockTrampoline 内部会保存一个 block 对象，然后根据传进来的参数，动态的构造一个 NSInvocation，通过执行 NSInvocation 返回需要的数据。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)invokeWithArguments:(RACTuple *)arguments &#123;</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">	SEL selector = [<span class="keyword">self</span> selectorForArgumentCount:arguments.count];</span><br><span class="line">	<span class="built_in">NSInvocation</span> *invocation = [<span class="built_in">NSInvocation</span> invocationWithMethodSignature:[<span class="keyword">self</span> methodSignatureForSelector:selector]];</span><br><span class="line">	invocation.selector = selector;</span><br><span class="line">	invocation.target = <span class="keyword">self</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i = <span class="number">0</span>; i &lt; arguments.count; i++) &#123;</span><br><span class="line">		<span class="keyword">id</span> arg = arguments[i];</span><br><span class="line">		<span class="built_in">NSInteger</span> argIndex = (<span class="built_in">NSInteger</span>)(i + <span class="number">2</span>);</span><br><span class="line">		[invocation setArgument:&amp;arg atIndex:argIndex];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	[invocation invoke];</span><br><span class="line">	</span><br><span class="line">	__<span class="keyword">unsafe_unretained</span> <span class="keyword">id</span> returnVal;</span><br><span class="line">	[invocation getReturnValue:&amp;returnVal];</span><br><span class="line">	<span class="keyword">return</span> returnVal;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (SEL)selectorForArgumentCount:(<span class="built_in">NSUInteger</span>)count &#123;</span><br><span class="line">	<span class="built_in">NSCParameterAssert</span>(count &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (count) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">0</span>: <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">1</span>: <span class="keyword">return</span> <span class="keyword">@selector</span>(performWith:);</span><br><span class="line">		<span class="keyword">case</span> <span class="number">2</span>: <span class="keyword">return</span> <span class="keyword">@selector</span>(performWith::);</span><br><span class="line">		<span class="keyword">case</span> <span class="number">3</span>: <span class="keyword">return</span> <span class="keyword">@selector</span>(performWith:::);</span><br><span class="line">		<span class="keyword">case</span> <span class="number">4</span>: <span class="keyword">return</span> <span class="keyword">@selector</span>(performWith::::);</span><br><span class="line">		<span class="keyword">case</span> <span class="number">5</span>: <span class="keyword">return</span> <span class="keyword">@selector</span>(performWith:::::);</span><br><span class="line">		<span class="keyword">case</span> <span class="number">6</span>: <span class="keyword">return</span> <span class="keyword">@selector</span>(performWith::::::);</span><br><span class="line">		<span class="keyword">case</span> <span class="number">7</span>: <span class="keyword">return</span> <span class="keyword">@selector</span>(performWith:::::::);</span><br><span class="line">		<span class="keyword">case</span> <span class="number">8</span>: <span class="keyword">return</span> <span class="keyword">@selector</span>(performWith::::::::);</span><br><span class="line">		<span class="keyword">case</span> <span class="number">9</span>: <span class="keyword">return</span> <span class="keyword">@selector</span>(performWith:::::::::);</span><br><span class="line">		<span class="keyword">case</span> <span class="number">10</span>: <span class="keyword">return</span> <span class="keyword">@selector</span>(performWith::::::::::);</span><br><span class="line">		<span class="keyword">case</span> <span class="number">11</span>: <span class="keyword">return</span> <span class="keyword">@selector</span>(performWith:::::::::::);</span><br><span class="line">		<span class="keyword">case</span> <span class="number">12</span>: <span class="keyword">return</span> <span class="keyword">@selector</span>(performWith::::::::::::);</span><br><span class="line">		<span class="keyword">case</span> <span class="number">13</span>: <span class="keyword">return</span> <span class="keyword">@selector</span>(performWith:::::::::::::);</span><br><span class="line">		<span class="keyword">case</span> <span class="number">14</span>: <span class="keyword">return</span> <span class="keyword">@selector</span>(performWith::::::::::::::);</span><br><span class="line">		<span class="keyword">case</span> <span class="number">15</span>: <span class="keyword">return</span> <span class="keyword">@selector</span>(performWith:::::::::::::::);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">NSCAssert</span>(<span class="literal">NO</span>, <span class="string">@"The argument count is too damn high! Only blocks of up to 15 arguments are currently supported."</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)performWith:(<span class="keyword">id</span>)obj1 :(<span class="keyword">id</span>)obj2 &#123;</span><br><span class="line">	<span class="keyword">id</span> (^block)(<span class="keyword">id</span>, <span class="keyword">id</span>) = <span class="keyword">self</span>.block;</span><br><span class="line">	<span class="keyword">return</span> block(obj1, obj2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><code>-invokeWithArguments</code> 中首先通过判断 RACTuple 元素数量选择对应的 selector，最大能支持 15 个元素。</p>
<p>确定好 NSInvocation 的 target 和 seletor，还需要设置参数</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i = <span class="number">0</span>; i &lt; arguments.count; i++) &#123;</span><br><span class="line">    <span class="keyword">id</span> arg = arguments[i];</span><br><span class="line">    <span class="built_in">NSInteger</span> argIndex = (<span class="built_in">NSInteger</span>)(i + <span class="number">2</span>);</span><br><span class="line">    [invocation setArgument:&amp;arg atIndex:argIndex];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里看到设置 <a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html" target="_blank" rel="noopener">Type Encodings</a> 的时候是从偏移量为 2开始，这是因为偏移量0和 偏移量1的参数分别对应着<strong>隐藏参数</strong>self 和 _cmd。</p>
<p>构造好 invocation 之后，执行 <code>[invocation invoke]</code> 调用动态方法，实际上就是执行代码4中的入参 reduceBlock 闭包，最后通过 <code>[invocation getReturnValue:&amp;returnVal]</code> 拿到闭包的返回值，也就是 RACBlockTrampoline 的最终返回值，最终成为 map 闭包里面的返回值。剩下的就是 map 函数流程。</p>
<h3 id="or"><a href="#or" class="headerlink" title="or"></a>or</h3><p>测试代码</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *sourceSignal = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    [subscriber sendNext:RACTuplePack(@NO,@YES,@NO)];</span><br><span class="line">    [subscriber sendNext:RACTuplePack(@YES,@NO)];</span><br><span class="line"></span><br><span class="line">    [subscriber sendCompleted];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line">RACSignal *orSignal = [sourceSignal or];</span><br><span class="line">[orSignal subscribeNext:^(<span class="keyword">id</span>  _Nullable x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"value = %@"</span>, x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">value = 1</span><br><span class="line">value = 1</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- (RACSignal *)or &#123;</span><br><span class="line">	<span class="keyword">return</span> [[<span class="keyword">self</span> map:^(RACTuple *tuple) &#123;</span><br><span class="line">		<span class="built_in">NSCAssert</span>([tuple isKindOfClass:RACTuple.class], <span class="string">@"-or must only be used on a signal of RACTuples of NSNumbers. Instead, received: %@"</span>, tuple);</span><br><span class="line">		<span class="built_in">NSCAssert</span>(tuple.count &gt; <span class="number">0</span>, <span class="string">@"-or must only be used on a signal of RACTuples of NSNumbers, with at least 1 value in the tuple"</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> @([tuple.rac_sequence any:^(<span class="built_in">NSNumber</span> *number) &#123;</span><br><span class="line">            <span class="comment">/// anyBlock</span></span><br><span class="line">			<span class="built_in">NSCAssert</span>([number isKindOfClass:<span class="built_in">NSNumber</span>.class], <span class="string">@"-or must only be used on a signal of RACTuples of NSNumbers. Instead, tuple contains a non-NSNumber value: %@"</span>, tuple);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> number.boolValue;</span><br><span class="line">		&#125;]);</span><br><span class="line">	&#125;] setNameWithFormat:<span class="string">@"[%@] -or"</span>, <span class="keyword">self</span>.name];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里主要是将 RACTuple 转换成 RACTupleSequence，因为 RACTupleSequence 是继承 RACSequence，这里就会调用 RACSequence 的 <code>- (BOOL)any:(BOOL (^)(id))block</code> 方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  RACSequence.m</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)any:(<span class="built_in">BOOL</span> (^)(<span class="keyword">id</span>))block &#123;</span><br><span class="line">    <span class="built_in">NSCParameterAssert</span>(block != <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// block = BOOL ^(NSNumber *number) &#123;return number.boolValue;&#125;</span></span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> objectPassingTest:block] != <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  RACSequence.m</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)objectPassingTest:(<span class="built_in">BOOL</span> (^)(<span class="keyword">id</span>))block &#123;</span><br><span class="line">    <span class="built_in">NSCParameterAssert</span>(block != <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// block = BOOL ^(NSNumber *number) &#123;return number.boolValue;&#125;</span></span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> filter:block].head;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>- (BOOL)any:(BOOL (^)(id))block</code> 实现里面最终会执行 RACStream 中的 <code>filter</code> 方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- (__kindof RACStream *)filter:(<span class="built_in">BOOL</span> (^)(<span class="keyword">id</span> value))block &#123;</span><br><span class="line">    <span class="built_in">NSCParameterAssert</span>(block != <span class="literal">nil</span>);</span><br><span class="line"></span><br><span class="line">    Class <span class="keyword">class</span> = <span class="keyword">self</span>.class;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> [[<span class="keyword">self</span> flattenMap:^ <span class="keyword">id</span> (<span class="keyword">id</span> value) &#123;</span><br><span class="line">        <span class="comment">// flattenMapBlock</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/// block = BOOL ^(NSNumber *number) &#123;return number.boolValue;&#125;</span></span><br><span class="line">        <span class="keyword">if</span> (block(value)) &#123; </span><br><span class="line">            <span class="keyword">return</span> [<span class="keyword">class</span> <span class="keyword">return</span>:value];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">class</span>.empty;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;] setNameWithFormat:<span class="string">@"[%@] -filter:"</span>, <span class="keyword">self</span>.name];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 flattenMapBlock 中会以 RACTupleSequence 发出的信号值传入到 block中，这些值信号值也就是一开始测试代码中 sourceSignal 发送给订阅者的 RACTuple 中的元素，如果value对应的BOOL值是YES，就转换成一个 RACTupleSequence 信号。如果对应的是NO，则转换成一个empty信号。</p>
<p>上面的 <code>flattenMap</code> 方法实际上最终调用到 RACSequence 的 <code>-bind</code> 方法<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    block = ^&#123;</span></span><br><span class="line"><span class="comment">        return ^(id value, BOOL *stop) &#123;</span></span><br><span class="line"><span class="comment">            id stream = block(value) ?: [class empty];</span></span><br><span class="line"><span class="comment">            NSCAssert([stream isKindOfClass:RACStream.class], @"Value returned from -flattenMap: is not a stream: %@", stream);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">            return stream;</span></span><br><span class="line"><span class="comment">        &#125;;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    bindBlock = ^(id value, BOOL *stop) &#123;</span></span><br><span class="line"><span class="comment">            id stream = block(value) ?: [class empty];</span></span><br><span class="line"><span class="comment">            NSCAssert([stream isKindOfClass:RACStream.class], @"Value returned from -flattenMap: is not a stream: %@", stream);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">            return stream;</span></span><br><span class="line"><span class="comment">        &#125;;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">- (RACSequence *)bind:(RACSequenceBindBlock (^)(<span class="keyword">void</span>))block &#123;</span><br><span class="line">    RACSequenceBindBlock bindBlock = block();</span><br><span class="line">    <span class="keyword">return</span> [[<span class="keyword">self</span> bind:bindBlock passingThroughValuesFromSequence:<span class="literal">nil</span>] setNameWithFormat:<span class="string">@"[%@] -bind:"</span>, <span class="keyword">self</span>.name];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后继续调用 <code>- (RACSequence *)bind:(RACSequenceBindBlock)bindBlock passingThroughValuesFromSequence:(RACSequence *)passthroughSequence</code> 这里参数 passthroughSequence 为 nil<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">- (RACSequence *)bind:(RACSequenceBindBlock)bindBlock passingThroughValuesFromSequence:(RACSequence *)passthroughSequence &#123;</span><br><span class="line"></span><br><span class="line">    __block RACSequence *valuesSeq = <span class="keyword">self</span>;</span><br><span class="line">    __block RACSequence *current = passthroughSequence;</span><br><span class="line">    __block <span class="built_in">BOOL</span> stop = <span class="literal">NO</span>;</span><br><span class="line"></span><br><span class="line">    RACSequence *sequence = [RACDynamicSequence sequenceWithLazyDependency:^ <span class="keyword">id</span> &#123;</span><br><span class="line">        <span class="comment">/// dependencyBlock</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (current.head == <span class="literal">nil</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (stop) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// We've exhausted the current sequence, create a sequence from the</span></span><br><span class="line">            <span class="comment">// next value.</span></span><br><span class="line">            <span class="keyword">id</span> value = valuesSeq.head;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (value == <span class="literal">nil</span>) &#123;</span><br><span class="line">                <span class="comment">// We've exhausted all the sequences.</span></span><br><span class="line">                stop = <span class="literal">YES</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            current = (<span class="keyword">id</span>)bindBlock(value, &amp;stop);</span><br><span class="line">            <span class="keyword">if</span> (current == <span class="literal">nil</span>) &#123;</span><br><span class="line">                stop = <span class="literal">YES</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            valuesSeq = valuesSeq.tail;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">NSCAssert</span>([current isKindOfClass:RACSequence.class], <span class="string">@"-bind: block returned an object that is not a sequence: %@"</span>, current);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; headBlock:^(<span class="keyword">id</span> _) &#123;</span><br><span class="line">        <span class="keyword">return</span> current.head;</span><br><span class="line">    &#125; tailBlock:^ <span class="keyword">id</span> (<span class="keyword">id</span> _) &#123;</span><br><span class="line">        <span class="keyword">if</span> (stop) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [valuesSeq bind:bindBlock passingThroughValuesFromSequence:current.tail];</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    sequence.name = <span class="keyword">self</span>.name;</span><br><span class="line">    <span class="keyword">return</span> sequence;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面代码的关键逻辑是调用 RACDynamicSequence 类的 <code>sequenceWithLazyDependency</code> 方法，dependencyBlock 会在之前提及到的函数 <code>-objectPassingTest</code> 中，执行 RACSequence 的 <code>-head</code> 方法中触发</p>
<p>在 方法，dependencyBlock 中，执行<code>current = (id)bindBlock(value, &amp;stop);</code> 根据value的布尔值来产生新的信号，如果为 NO 则返回 RACEmptySequence 类型，此时 current.head 为 nil，进行下一次循环；如过 value 为YES，则返回 RACUnarySequence 类型，current.head 不为 nil，结束循环。</p>
<h3 id="any"><a href="#any" class="headerlink" title="any:"></a>any:</h3><p>测试代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)testAny &#123;</span><br><span class="line">    RACSignal *sourceSignal = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">        [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">        [subscriber sendNext:@<span class="number">2</span>];</span><br><span class="line">        [subscriber sendNext:@<span class="number">3</span>];</span><br><span class="line">        </span><br><span class="line">        [subscriber sendCompleted];</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    [[sourceSignal any:^<span class="built_in">BOOL</span>(<span class="keyword">id</span>  _Nullable object) &#123;</span><br><span class="line">        <span class="keyword">return</span> [object integerValue] &lt; <span class="number">2</span>;</span><br><span class="line">    &#125;] subscribeNext:^(<span class="built_in">NSNumber</span> * _Nullable x) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"value = %@"</span>, x);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">value = 1</span><br><span class="line">value = 0</span><br><span class="line">value = 0</span><br></pre></td></tr></table></figure>
<p>底层实现：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- (RACSignal *)any:(<span class="built_in">BOOL</span> (^)(<span class="keyword">id</span> object))predicateBlock &#123;</span><br><span class="line">	<span class="built_in">NSCParameterAssert</span>(predicateBlock != <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> [[[<span class="keyword">self</span> materialize] bind:^&#123;</span><br><span class="line">		<span class="keyword">return</span> ^(RACEvent *event, <span class="built_in">BOOL</span> *stop) &#123;</span><br><span class="line">			<span class="keyword">if</span> (event.finished) &#123;</span><br><span class="line">				*stop = <span class="literal">YES</span>;</span><br><span class="line">				<span class="keyword">return</span> [RACSignal <span class="keyword">return</span>:@NO];</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (predicateBlock(event.value)) &#123;</span><br><span class="line">				*stop = <span class="literal">YES</span>;</span><br><span class="line">				<span class="keyword">return</span> [RACSignal <span class="keyword">return</span>:@YES];</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> [RACSignal empty];</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;] setNameWithFormat:<span class="string">@"[%@] -any:"</span>, <span class="keyword">self</span>.name];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先原信号会 通过 <code>-materialize</code> 方法转换成 RACEvent 对象</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- (RACSignal *)materialize &#123;</span><br><span class="line">	<span class="keyword">return</span> [[RACSignal createSignal:^(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">		<span class="keyword">return</span> [<span class="keyword">self</span> subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">			[subscriber sendNext:[RACEvent eventWithValue:x]];</span><br><span class="line">		&#125; error:^(<span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">			[subscriber sendNext:[RACEvent eventWithError:error]];</span><br><span class="line">			[subscriber sendCompleted];</span><br><span class="line">		&#125; completed:^&#123;</span><br><span class="line">			[subscriber sendNext:RACEvent.completedEvent];</span><br><span class="line">			[subscriber sendCompleted];</span><br><span class="line">		&#125;];</span><br><span class="line">	&#125;] setNameWithFormat:<span class="string">@"[%@] -materialize"</span>, <span class="keyword">self</span>.name];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)isFinished &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">self</span>.eventType == RACEventTypeCompleted || <span class="keyword">self</span>.eventType == RACEventTypeError;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面代码发现，RACEvent 如果收到原信号的 sendCompleted / sendError，finished 属性会置为 YES</p>
<p>在 <code>-any</code> 方法中，先判断 RACEvent 的 finished 属性，如果为 YES，stop接下来的信号 则返回 [RACSignal return:@NO]；反之，则会根据入参 predicateBlock 闭包，将 RACEvent 的 value 传入 predicateBlock，如果返回值为YES，stop接下来的信号，则返回 [RACSignal return:@YES]；如果 predicateBlock 返回值为 NO，则返回 [RACSignal empty]。</p>
<p>简单地总结来说，any 方法根据 predicateBlock 来对原信号的每一个信号进行判断，若遇到返回 YES 的条件，就给订阅者发送 YES 信号，然后发送 sendCompleted；若 predicateBlock 没有返回 YES 的条件，则最后给 订阅者 发送 NO 信号。</p>
<h3 id="all"><a href="#all" class="headerlink" title="all"></a>all</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- (RACSignal *)all:(<span class="built_in">BOOL</span> (^)(<span class="keyword">id</span> object))predicateBlock &#123;</span><br><span class="line">    <span class="built_in">NSCParameterAssert</span>(predicateBlock != <span class="literal">NULL</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> [[[<span class="keyword">self</span> materialize] bind:^&#123;</span><br><span class="line">        <span class="keyword">return</span> ^(RACEvent *event, <span class="built_in">BOOL</span> *stop) &#123;</span><br><span class="line">            <span class="keyword">if</span> (event.eventType == RACEventTypeCompleted) &#123;</span><br><span class="line">                *stop = <span class="literal">YES</span>;</span><br><span class="line">                <span class="keyword">return</span> [RACSignal <span class="keyword">return</span>:@YES];</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (event.eventType == RACEventTypeError || !predicateBlock(event.value)) &#123;</span><br><span class="line">                *stop = <span class="literal">YES</span>;</span><br><span class="line">                <span class="keyword">return</span> [RACSignal <span class="keyword">return</span>:@NO];</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> [RACSignal empty];</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;] setNameWithFormat:<span class="string">@"[%@] -all:"</span>, <span class="keyword">self</span>.name];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>all 方法可以理解为 any 方法的对立面，原信号如果发送 sendError 或者 predicateBlock 返回为 NO，就会结束信号的传递，并会给订阅者发值为 NO 的信号。如果整个订阅过程中都没有出现错误以及都满足 predicateBlock 为真的条件，最后会在 RACEventTypeCompleted 的时候发送 YES。</p>
<h3 id="repeat"><a href="#repeat" class="headerlink" title="repeat"></a>repeat</h3><p>测试代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *sourceSignal = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    [subscriber sendCompleted];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line">RACSignal *orSignal = [sourceSignal repeat];</span><br><span class="line">[orSignal subscribeNext:^(<span class="keyword">id</span>  _Nullable x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"value = %@"</span>, x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">value = 1</span><br><span class="line">value = 1</span><br><span class="line">value = 1</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>执行之后会不断地打印 <code>value = 1</code></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- (RACSignal *)repeat &#123;</span><br><span class="line">    <span class="keyword">return</span> [[RACSignal createSignal:^(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">        <span class="keyword">return</span> subscribeForever(<span class="keyword">self</span>,</span><br><span class="line">                                ^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">                                    [subscriber sendNext:x];</span><br><span class="line">                                &#125;,</span><br><span class="line">                                ^(<span class="built_in">NSError</span> *error, RACDisposable *disposable) &#123;</span><br><span class="line">                                    [disposable dispose];</span><br><span class="line">                                    [subscriber sendError:error];</span><br><span class="line">                                &#125;,</span><br><span class="line">                                ^(RACDisposable *disposable) &#123;</span><br><span class="line">                                    <span class="comment">// Resubscribe.</span></span><br><span class="line">                                &#125;);</span><br><span class="line">    &#125;] setNameWithFormat:<span class="string">@"[%@] -repeat"</span>, <span class="keyword">self</span>.name];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行 <code>-repeat</code> 方法之后，内部会创建新的 RASignal，当新的信号被订阅的时候会执行 <code>subscribeForever</code> 方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> RACDisposable *subscribeForever (RACSignal *signal, <span class="keyword">void</span> (^next)(<span class="keyword">id</span>), <span class="keyword">void</span> (^error)(<span class="built_in">NSError</span> *, RACDisposable *), <span class="keyword">void</span> (^completed)(RACDisposable *)) &#123;</span><br><span class="line">	next = [next <span class="keyword">copy</span>];</span><br><span class="line">	error = [error <span class="keyword">copy</span>];</span><br><span class="line">	completed = [completed <span class="keyword">copy</span>];</span><br><span class="line"></span><br><span class="line">	RACCompoundDisposable *compoundDisposable = [RACCompoundDisposable compoundDisposable];</span><br><span class="line"></span><br><span class="line">	RACSchedulerRecursiveBlock recursiveBlock = ^(<span class="keyword">void</span> (^recurse)(<span class="keyword">void</span>)) &#123;</span><br><span class="line">		RACCompoundDisposable *selfDisposable = [RACCompoundDisposable compoundDisposable];</span><br><span class="line">		[compoundDisposable addDisposable:selfDisposable];</span><br><span class="line"></span><br><span class="line">		__<span class="keyword">weak</span> RACDisposable *weakSelfDisposable = selfDisposable;</span><br><span class="line"></span><br><span class="line">		RACDisposable *subscriptionDisposable = [signal subscribeNext:next error:^(<span class="built_in">NSError</span> *e) &#123;</span><br><span class="line">			<span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">				error(e, compoundDisposable);</span><br><span class="line">				[compoundDisposable removeDisposable:weakSelfDisposable];</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			recurse();</span><br><span class="line">		&#125; completed:^&#123;</span><br><span class="line">			<span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">				completed(compoundDisposable);</span><br><span class="line">				[compoundDisposable removeDisposable:weakSelfDisposable];</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			recurse();</span><br><span class="line">		&#125;];</span><br><span class="line"></span><br><span class="line">		[selfDisposable addDisposable:subscriptionDisposable];</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Subscribe once immediately, and then use recursive scheduling for any</span></span><br><span class="line">	<span class="comment">// further resubscriptions.</span></span><br><span class="line">	recursiveBlock(^&#123;</span><br><span class="line">		RACScheduler *recursiveScheduler = RACScheduler.currentScheduler ?: [RACScheduler scheduler];</span><br><span class="line"></span><br><span class="line">		RACDisposable *schedulingDisposable = [recursiveScheduler scheduleRecursiveBlock:recursiveBlock];</span><br><span class="line">		[compoundDisposable addDisposable:schedulingDisposable];</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> compoundDisposable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> <code>subscribeForever</code> 方法有4个参数，分别是源信号 signal，next 闭包，error 闭包和 complete 闭包。函数内部先定义好递归的闭包:recursiveBlock，recursiveBlock 中 首先对 signal 进行订阅，如果源信号 signal 发送 sendError 或者 sendCompleted，就会执行对应的 error/complete 闭包，然后就执行 recursiveBlock 的参数闭包 recurse。</p>
<p> <code>subscribeForever</code>  最后是执行 recursiveBlock 并传入具体的 recurse。</p>
<p>recurse 中首先获取当前的递归调度器 recursiveScheduler，然后执行 <code>-scheduleRecursiveBlock</code> 方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">- (RACDisposable *)scheduleRecursiveBlock:(RACSchedulerRecursiveBlock)recursiveBlock &#123;</span><br><span class="line">	RACCompoundDisposable *disposable = [RACCompoundDisposable compoundDisposable];</span><br><span class="line"></span><br><span class="line">	[<span class="keyword">self</span> scheduleRecursiveBlock:[recursiveBlock <span class="keyword">copy</span>] addingToDisposable:disposable];</span><br><span class="line">	<span class="keyword">return</span> disposable;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)scheduleRecursiveBlock:(RACSchedulerRecursiveBlock)recursiveBlock addingToDisposable:(RACCompoundDisposable *)disposable &#123;</span><br><span class="line">	<span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">		RACCompoundDisposable *selfDisposable = [RACCompoundDisposable compoundDisposable];</span><br><span class="line">		[disposable addDisposable:selfDisposable];</span><br><span class="line"></span><br><span class="line">		__<span class="keyword">weak</span> RACDisposable *weakSelfDisposable = selfDisposable;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 最终调用 schedule 方法</span></span><br><span class="line">		RACDisposable *schedulingDisposable = [<span class="keyword">self</span> schedule:^&#123;</span><br><span class="line">            <span class="comment">/// scheduleBlock</span></span><br><span class="line">            </span><br><span class="line">			<span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">				<span class="comment">// At this point, we've been invoked, so our disposable is now useless.</span></span><br><span class="line">				[disposable removeDisposable:weakSelfDisposable];</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (disposable.disposed) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">void</span> (^reallyReschedule)(<span class="keyword">void</span>) = ^&#123;</span><br><span class="line">				<span class="keyword">if</span> (disposable.disposed) <span class="keyword">return</span>;</span><br><span class="line">				[<span class="keyword">self</span> scheduleRecursiveBlock:recursiveBlock addingToDisposable:disposable];</span><br><span class="line">			&#125;;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Protects the variables below.</span></span><br><span class="line">			<span class="comment">//</span></span><br><span class="line">			<span class="comment">// This doesn't actually need to be __block qualified, but Clang</span></span><br><span class="line">			<span class="comment">// complains otherwise. :C</span></span><br><span class="line">			__block <span class="built_in">NSLock</span> *lock = [[<span class="built_in">NSLock</span> alloc] init];</span><br><span class="line">			lock.name = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@ %s"</span>, <span class="keyword">self</span>, sel_getName(_cmd)];</span><br><span class="line"></span><br><span class="line">			__block <span class="built_in">NSUInteger</span> rescheduleCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Set to YES once synchronous execution has finished. Further</span></span><br><span class="line">			<span class="comment">// rescheduling should occur immediately (rather than being</span></span><br><span class="line">			<span class="comment">// flattened).</span></span><br><span class="line">			__block <span class="built_in">BOOL</span> rescheduleImmediately = <span class="literal">NO</span>;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">				recursiveBlock(^&#123;</span><br><span class="line">					[lock lock];</span><br><span class="line">					<span class="built_in">BOOL</span> immediate = rescheduleImmediately;</span><br><span class="line">					<span class="keyword">if</span> (!immediate) ++rescheduleCount;</span><br><span class="line">					[lock unlock];</span><br><span class="line"></span><br><span class="line">					<span class="keyword">if</span> (immediate) reallyReschedule();</span><br><span class="line">				&#125;);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			[lock lock];</span><br><span class="line">			<span class="built_in">NSUInteger</span> synchronousCount = rescheduleCount;</span><br><span class="line">			rescheduleImmediately = <span class="literal">YES</span>;</span><br><span class="line">			[lock unlock];</span><br><span class="line"></span><br><span class="line">			<span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i = <span class="number">0</span>; i &lt; synchronousCount; i++) &#123;</span><br><span class="line">				reallyReschedule();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;];</span><br><span class="line"></span><br><span class="line">		[selfDisposable addDisposable:schedulingDisposable];</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// RACTargetQueueScheduler.m</span></span><br><span class="line">- (RACDisposable *)schedule:(<span class="keyword">void</span> (^)(<span class="keyword">void</span>))block &#123;</span><br><span class="line">	<span class="built_in">NSCParameterAssert</span>(block != <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	RACDisposable *disposable = [[RACDisposable alloc] init];</span><br><span class="line"></span><br><span class="line">	<span class="built_in">dispatch_async</span>(<span class="keyword">self</span>.queue, ^&#123;</span><br><span class="line">		<span class="keyword">if</span> (disposable.disposed) <span class="keyword">return</span>;</span><br><span class="line">		[<span class="keyword">self</span> performAsCurrentScheduler:block];</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> disposable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到会调用到自己的 <code>-schedule</code> 方法，这里测试代码中是在主线程，获取到对应的是 RACTargetQueueScheduler 。这里的 <code>-schedule</code> 方法先判断原信号有没有disposed，若果没有，则把参数 block 放在对应的队列中触发。</p>
<p>可以看得到上面函数中 scheduleBlock 里不断递归执行 <code>[self scheduleRecursiveBlock:recursiveBlock addingToDisposable:disposable]</code>，recursiveBlock 不断被触发，对应的 <code>subscribeForever</code> 中的 recurse() 循环执行：</p>
<p>scheduleRecursiveBlock-&gt;recursiveBlock-&gt;recurse()-&gt;reallyReschedule()-&gt;scheduleRecursiveBlock</p>
<p>也就是说源信号会循环被订阅触发其给订阅者发送 sendNext 事件，直到源信号发送 error 才结束。</p>
<h3 id="retry"><a href="#retry" class="headerlink" title="retry:"></a>retry:</h3><p>测试代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)testRetry &#123;</span><br><span class="line">    RACSignal *sourceSignal = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">        [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">        [subscriber sendNext:@<span class="number">2</span>];</span><br><span class="line">        </span><br><span class="line">        [subscriber sendError:[<span class="built_in">NSError</span> errorWithDomain:<span class="string">@"domain"</span> code:<span class="number">-1</span> userInfo:<span class="literal">nil</span>]];</span><br><span class="line">        </span><br><span class="line">        [subscriber sendNext:@<span class="number">3</span>];</span><br><span class="line">        </span><br><span class="line">        [subscriber sendCompleted];</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    RACSignal *retrySignal = [sourceSignal retry:<span class="number">2</span>];</span><br><span class="line">    [retrySignal subscribeNext:^(<span class="keyword">id</span>  _Nullable x) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"value = %@"</span>, x);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">value = 1</span><br><span class="line">value = 2</span><br><span class="line">value = 1</span><br><span class="line">value = 2</span><br><span class="line">value = 1</span><br><span class="line">value = 2</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">- (RACSignal *)retry:(<span class="built_in">NSInteger</span>)retryCount &#123;</span><br><span class="line">	<span class="keyword">return</span> [[RACSignal createSignal:^(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">		__block <span class="built_in">NSInteger</span> currentRetryCount = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">return</span> subscribeForever(<span class="keyword">self</span>,</span><br><span class="line">			^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">				[subscriber sendNext:x];</span><br><span class="line">			&#125;,</span><br><span class="line">			^(<span class="built_in">NSError</span> *error, RACDisposable *disposable) &#123;</span><br><span class="line">                <span class="comment">// 当原始信号发送 sendError 时</span></span><br><span class="line">				<span class="keyword">if</span> (retryCount == <span class="number">0</span> || currentRetryCount &lt; retryCount) &#123;</span><br><span class="line">					<span class="comment">// Resubscribe.</span></span><br><span class="line">					currentRetryCount++;</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				[disposable dispose];</span><br><span class="line">				[subscriber sendError:error];</span><br><span class="line">			&#125;,</span><br><span class="line">			^(RACDisposable *disposable) &#123;</span><br><span class="line">                <span class="comment">// 当原信号发送 sendCompleted</span></span><br><span class="line">				[disposable dispose];</span><br><span class="line">				[subscriber sendCompleted];</span><br><span class="line">			&#125;);</span><br><span class="line">	&#125;] setNameWithFormat:<span class="string">@"[%@] -retry: %lu"</span>, <span class="keyword">self</span>.name, (<span class="keyword">unsigned</span> <span class="keyword">long</span>)retryCount];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>-retry:</code> 实现与 <code>-repeat</code> 实现类似，基于 <code>subscribeForever</code>。<code>-retry:</code>  是内部维护一个 currentRetryCount 变量，当原始信号发送 sendError 时判断重试次数 currentRetryCount 是否小于 retryCount，若是则重试，如果重试依旧收到 sendError，超过 retryCount 之后就会停止重试。</p>
<p>如果原信号没有发生错误，那么原信号在发送结束，当原信号发送 sendCompleted，<code>subscribeForever</code> 也就接受了，所以 <code>-retry:</code> 操作对于没有任何error的信号 和 直接订阅原信号表现一样。</p>
<p>将测试代码改为:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)testRetryNoError &#123;</span><br><span class="line">    RACSignal *sourceSignal = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">        [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">        [subscriber sendNext:@<span class="number">2</span>];        </span><br><span class="line">        [subscriber sendCompleted];</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    RACSignal *retrySignal = [sourceSignal retry:<span class="number">2</span>];</span><br><span class="line">    [retrySignal subscribeNext:^(<span class="keyword">id</span>  _Nullable x) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"value = %@"</span>, x);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">value = 1</span><br><span class="line">value = 2</span><br></pre></td></tr></table></figure>
<p>原信号发送 sendCompleted ，整个订阅流程就结束了。</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/ReactiveCocoa/" rel="tag"># ReactiveCocoa</a>
          
            <a href="/tags/iOS/" rel="tag"># iOS</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/01/13/RACSignal-concat-zipWith/" rel="next" title="RACSignal-concat与zipWith过程解析">
                <i class="fa fa-chevron-left"></i> RACSignal-concat与zipWith过程解析
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/01/31/RACSignal-Operations-2/" rel="prev" title="RACSignal常用方法深入分析(2)">
                RACSignal常用方法深入分析(2) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Chipengliu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">20</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">2</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">8</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/chipengliu" title="GitHub &rarr; https://github.com/chipengliu" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:liuchipeng1991@163.com" title="E-Mail &rarr; mailto:liuchipeng1991@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#doNext"><span class="nav-number">1.</span> <span class="nav-text">doNext</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#throttle-valuesPassingTest"><span class="nav-number">2.</span> <span class="nav-text">throttle:valuesPassingTest:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#delay"><span class="nav-number">3.</span> <span class="nav-text">delay:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bufferWithTime-onScheduler"><span class="nav-number">4.</span> <span class="nav-text">bufferWithTime:onScheduler:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#timeout-onScheduler"><span class="nav-number">5.</span> <span class="nav-text">timeout:onScheduler:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#map"><span class="nav-number">6.</span> <span class="nav-text">map:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mapReplace"><span class="nav-number">7.</span> <span class="nav-text">mapReplace</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#reduceEach"><span class="nav-number">8.</span> <span class="nav-text">reduceEach</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#or"><span class="nav-number">9.</span> <span class="nav-text">or</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#any"><span class="nav-number">10.</span> <span class="nav-text">any:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#all"><span class="nav-number">11.</span> <span class="nav-text">all</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#repeat"><span class="nav-number">12.</span> <span class="nav-text">repeat</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#retry"><span class="nav-number">13.</span> <span class="nav-text">retry:</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chipengliu</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.0.0</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="总访客量">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="post-meta-divider">|</span>
  

  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="总访问量">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.0"></script>

  <script src="/js/src/motion.js?v=7.0.0"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.0"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.0"></script>




  
  <script src="/js/src/scrollspy.js?v=7.0.0"></script>
<script src="/js/src/post-details.js?v=7.0.0"></script>



  


  <script src="/js/src/bootstrap.js?v=7.0.0"></script>



  


  


  




  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
